let recognition,isSpeechRecognitionActive=!1;function setupSpeechRecognition(){let n=window.SpeechRecognition||window.webkitSpeechRecognition;if(!n){showToast("Tr\xecnh duyệt n\xe0y kh\xf4ng hỗ trợ Điều khiển bằng giọng n\xf3i.","error");return}(recognition=new n).continuous=!0,recognition.interimResults=!1,recognition.lang="vi-VN",recognition.onstart=function(){isSpeechRecognitionActive=!0},recognition.onresult=function(n){if(window.isEditingPlaylist){console.log("Lệnh giọng n\xf3i bị bỏ qua: Đang trong chế độ chỉnh sửa danh s\xe1ch ph\xe1t.");return}let i="";for(let e=n.resultIndex;e<n.results.length;++e)n.results[e].isFinal&&(i+=n.results[e][0].transcript);if(i=wordsToNumbers(i=i.toLowerCase().trim()),console.log("Đ\xe3 nhận dạng giọng n\xf3i:",i),(i.includes("tiếp")||i.includes("next")||i.includes("b\xe0i sau"))&&(showToast("Lệnh giọng n\xf3i: Chuyển b\xe0i kế tiếp","info"),nextVideoTrack()),(i.includes("trước")||i.includes("previous")||i.includes("b\xe0i trước"))&&(showToast("Lệnh giọng n\xf3i: Quay lại b\xe0i trước","info"),previousVideoTrack()),(i.includes("lặp")||i.includes("loop"))&&(loopVideo.click(),showToast("Lệnh giọng n\xf3i: Bật/Tắt lặp video","info")),(i.includes("dừng")||i.includes("pause"))&&!videoPlayer.paused&&(videoPlayer.pause(),showToast("Lệnh giọng n\xf3i: Tạm dừng","info")),(i.includes("ph\xe1t")||i.includes("play")||i.includes("tiếp tục"))&&videoPlayer.paused&&(videoPlayer.play(),showToast("Lệnh giọng n\xf3i: Ph\xe1t nhạc","info")),(i.includes("ngẫu nhi\xean")||i.includes("random"))&&shuffleButton.click(),(i.includes("default")||i.includes("mặc định"))&&loadPlaylist("default"),i.includes("\xe2m lượng")||i.includes("volume")){let t=i.match(/[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)/);volumePercent=parseFloat(t)/100,videoPlayer.volume=volumePercent}if(i.includes("độ trễ")||i.includes("delay")){let o=i.match(/[+-]?([0-9]+([.,][0-9]*)?|[.][0-9]+)/),c=o[0].replace(",",".");if(o){let r=parseFloat(c,10);if(isNaN(r)||r<0){showToast("Độ trễ kh\xf4ng đ\xfang. Vui l\xf2ng nhập lại độ trễ.","error");return}if(r>25){showToast("Đ\xe2y kh\xf4ng phải l\xe0 nơi để bạn đi ngủ :V");return}updateDelay(r),showToast(`Độ trễ được cập nhật th\xe0nh: ${r} gi\xe2y`)}else showToast("Kh\xf4ng thể nhận dạng số gi\xe2y cho độ trễ","error")}},recognition.onerror=function(n){"no-speech"===n.error||("audio-capture"===n.error?showToast("Lỗi thu \xe2m thanh cho điều khiển giọng n\xf3i.","error"):"not-allowed"===n.error?showToast("Bạn cần cấp quyền truy cập micro cho điều khiển giọng n\xf3i.","error"):"network"===n.error&&(console.warn("Lỗi mạng với điều khiển giọng n\xf3i. Sẽ thử khởi động lại."),setTimeout(startSpeechRecognition,1e3)))},recognition.onend=function(){if(isSpeechRecognitionActive)try{recognition.start()}catch(n){console.error("Lỗi khi tự động khởi động lại điều khiển giọng n\xf3i:",n),isSpeechRecognitionActive=!1}}}function startSpeechRecognition(){if(recognition&&!isSpeechRecognitionActive)try{recognition.start()}catch(n){console.error("Lỗi khi bắt đầu nhận dạng giọng n\xf3i:",n),isSpeechRecognitionActive=!1,"InvalidStateError"===n.name&&(console.log("Thử khởi tạo lại SpeechRecognition do InvalidStateError."),setupSpeechRecognition(),recognition&&recognition.start())}else!recognition&&(console.log("SpeechRecognition chưa được thiết lập. Đang thử thiết lập..."),setupSpeechRecognition(),recognition&&startSpeechRecognition())}function stopSpeechRecognition(){recognition&&isSpeechRecognitionActive&&(isSpeechRecognitionActive=!1,recognition.stop(),console.log("Điều khiển bằng giọng n\xf3i đ\xe3 được tắt."))}function wordsToNumbers(n){let i={không:"0",một:"1",hai:"2",ba:"3",bốn:"4",năm:"5",sáu:"6",bảy:"7",tám:"8",chín:"9",mười:"10",zero:"0",one:"1",two:"2",three:"3",four:"4",five:"5",six:"6",seven:"7",eight:"8",nine:"9",ten:"10"},e=n.toLowerCase();return Object.keys(i).forEach(n=>{e=e.replace(RegExp("\\b"+n+"\\b","g"),i[n])}),e}setupSpeechRecognition();