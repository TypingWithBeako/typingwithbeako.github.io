let currentEditingPlaylist="",tempPlaylistSongs=[];function loadPlaylist(e){if("default"===e){var t=[`${URL}OP1 - Redo.mp4`,`${URL}ED1 - STYX HELIX.mp4`,`${URL}OP2 - Paradisus - Paradoxum.mp4`,`${URL}ED2 - Stay Alive.webm`,`${URL}OP3 - Realize.mp4`,`${URL}ED3 - Memento.mp4`,`${URL}OP4 - Long shot.mp4`,`${URL}ED4 - Believe in you.webm`,`${URL}OP5 - Reweave.mp4`,`${URL}ED5 - NOX LUX.mp4`,],l=[`${URL}STRAIGHT BET.mp4`,`${URL}Bouya no Yume yo.mp4`,`${URL}Memories.mp4`,`${URL}White White Snow.mp4`,`${URL}Requiem of Silence.mp4`,`${URL}Wishing.mp4`,`${URL}Yuki no hate ni Kimi no na wo.mp4`,`${URL}Door.mp4`,`${URL}What you don't know.mp4`,`${URL}I Trust You.mp4`,];videoUrls=t,newvideoUrls=l,playVideo(videoUrls[0]),showToast(`Đ\xe3 kh\xf4i phục danh s\xe1ch ph\xe1t mặc định.`);return}let a=(JSON.parse(localStorage.getItem("playlists"))||{})[e];a&&a.songs&&(videoUrls=a.songs.map(e=>convertToUrl(e)),currentIndex=0,playVideo(videoUrls[0]))}function convertToUrl(e){return"ED2 - Stay Alive"===e||"ED4 - Believe in you"===e||"S1 Ending"===e?`${URL}${e}.webm`:`${URL}${e}.mp4`}function populateSidebarPlaylists(){let e=JSON.parse(localStorage.getItem("playlists"))||{},t=document.getElementById("dynamic-playlists");t.innerHTML="",Object.keys(e).forEach(l=>{let a=document.createElement("li");a.innerHTML=`
            <div class="flex items-center p-2 pl-11 w-full text-base font-normal text-gray-900 rounded-lg transition duration-75 group hover:bg-blue-100">
                <div onclick="loadPlaylist('${l}')" class="flex-1 text-left">
                    ${l} (${e[l].songs.length} b\xe0i h\xe1t)
                </div>
                <div class="flex gap-1">
                    <button onclick="editPlaylist('${l}')" class="text-blue-500 hover:text-blue-700" title="Chỉnh sửa">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                        </svg>
                    </button>
                    <button onclick="deletePlaylist('${l}')" class="text-red-500 hover:text-red-700" title="X\xf3a">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9zM4 5a2 2 0 012-2h8a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 102 0v3a1 1 0 11-2 0V9zm4 0a1 1 0 10-2 0v3a1 1 0 102 0V9z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            </div>
        `,t.appendChild(a)})}function createNewPlaylist(){let e=prompt("T\xean danh s\xe1ch ph\xe1t:");if(e&&e.trim()){let t=JSON.parse(localStorage.getItem("playlists"))||{};t[e.trim()]={songs:[],created:new Date().toISOString(),description:""},localStorage.setItem("playlists",JSON.stringify(t)),populateSidebarPlaylists(),showToast(`Đ\xe3 th\xeam danh s\xe1ch ph\xe1t ${e} th\xe0nh c\xf4ng.`),editPlaylist(e.trim())}}function deletePlaylist(e){if(confirm(`X\xf3a danh s\xe1ch "${e}"?`)){let t=JSON.parse(localStorage.getItem("playlists"))||{};delete t[e],localStorage.setItem("playlists",JSON.stringify(t)),populateSidebarPlaylists()}}function editPlaylist(e){let t=JSON.parse(localStorage.getItem("playlists"))||{},l=t[e];if(currentEditingPlaylist=e,tempPlaylistSongs=[...l.songs],window.isEditingPlaylist=!0,!l)return;let a=createPlaylistEditorModal(e,l);document.body.appendChild(a),setTimeout(()=>a.style.opacity="1",10)}function createPlaylistEditorModal(e,t){let l=document.createElement("div");return l.className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300",l.style.opacity="0",l.id="playlist-editor-modal",l.innerHTML=`
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-6xl w-full mx-4 h-[90vh] overflow-hidden shadow-2xl flex flex-col">
            <div class="flex justify-between items-center mb-6 flex-shrink-0">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Chỉnh sửa danh s\xe1ch</h2>
                    <h4 class="mt-1 font-medium text-gray-600 dark:text-gray-400">${e} • ${t.songs.length} b\xe0i h\xe1t</h4>
                </div>
                <button onclick="closePlaylistEditor()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 transition-colors">
                    <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 flex-1 min-h-0">
                <!-- Available Songs -->
                <div class="flex flex-col min-h-0">
                    <div class="flex items-center justify-between mb-4 flex-shrink-0">
                        <input type="text" id="song-search" placeholder="T\xecm kiếm..." 
                            class="px-3 py-1 border rounded text-sm w-48 dark:bg-gray-700 dark:border-gray-600" 
                            oninput="filterAvailableSongs()">
                    </div>
                    <div id="available-songs" class="border rounded-lg p-4 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 overflow-y-auto playlist-container-height">
                        ${generateAvailableSongsList(t.songs)}
                    </div>
                </div>
                
                <!-- Current Playlist -->
                <div class="flex flex-col min-h-0">
                    <div class="flex items-center justify-between mb-6 flex-shrink-0">
                        <button onclick="clearPlaylist('${e}')" class="text-red-500 hover:text-red-700 text-sm">
                            X\xf3a tất cả
                        </button>
                    </div>
                    <div id="current-playlist" class="border rounded-lg p-4 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 overflow-y-auto playlist-container-height">
                        ${generateCurrentPlaylistList(t.songs)}
                    </div>
                </div>
            </div>
            
            <div class="flex justify-between items-center mt-6 flex-shrink-0">
                <div class="text-sm text-gray-600 dark:text-gray-400">
                    K\xe9o thả để sắp xếp lại • Nhấp đ\xfap để th\xeam/x\xf3a
                </div>
                <div class="flex gap-3">
                    <button onclick="closePlaylistEditor()" class="px-6 py-2 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition-colors">
                        Hủy
                    </button>
                    <button onclick="savePlaylist('${e}')" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        Lưu thay đổi
                    </button>
                </div>
            </div>
        </div>
    `,l.addEventListener("click",e=>{e.target===l&&closePlaylistEditor()}),l}function clearPlaylist(e){confirm(`X\xf3a tất cả b\xe0i h\xe1t khỏi danh s\xe1ch "${e}"? Lưu \xfd: Danh s\xe1ch trống kh\xf4ng thể được lưu.`)&&(tempPlaylistSongs=[],refreshModalContent())}document.addEventListener("DOMContentLoaded",populateSidebarPlaylists);let draggedIndex=null;function dragStart(e,t){draggedIndex=t,e.dataTransfer.effectAllowed="move",e.target.style.opacity="0.5"}function dragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="move"}function dragDrop(e,t){if(e.preventDefault(),null!==draggedIndex&&draggedIndex!==t){let l=tempPlaylistSongs[draggedIndex];tempPlaylistSongs.splice(draggedIndex,1),tempPlaylistSongs.splice(t,0,l),refreshModalContent()}draggedIndex=null,e.target.style.opacity="1"}function dragEnd(e){e.target.style.opacity="1",draggedIndex=null}function filterAvailableSongs(){let e=document.getElementById("song-search").value.toLowerCase(),t=document.getElementById("available-songs"),l=t.querySelectorAll("[data-song]");l.forEach(t=>{let l=t.getAttribute("data-song").toLowerCase();l.includes(e)?t.style.display="flex":t.style.display="none"})}function generateAvailableSongsList(e){let t=getAllAvailableSongs();return t.map(t=>{let l=e.includes(t);return`
            <div class="flex items-center justify-between p-2 rounded hover:bg-white dark:hover:bg-gray-600 transition-colors border border-transparent hover:border-gray-200 dark:hover:border-gray-500 ${l?"opacity-50":""}" 
                 ondblclick="addSongToCurrentPlaylist('${t}')" 
                 data-song="${t}">
                <span class="text-sm font-medium ${l?"line-through":""}">${t}</span>
                <button onclick="addSongToCurrentPlaylist('${t}')" 
                        class="text-blue-500 hover:text-blue-700 ${l?"opacity-50 cursor-not-allowed":""}"
                        ${l?"disabled":""}>
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        `}).join("")}function generateCurrentPlaylistList(e){return 0===e.length?'<div class="text-center text-gray-500 dark:text-gray-400 py-8">Danh s\xe1ch trống<br><small>Th\xeam b\xe0i h\xe1t từ cột b\xean tr\xe1i</small></div>':e.map((e,t)=>`
        <div class="flex items-center justify-between p-3 rounded bg-white dark:bg-gray-600 border dark:border-gray-500 mb-2 cursor-move" 
             draggable="true" 
             ondragstart="dragStart(event, ${t})" 
             ondragover="dragOver(event)" 
             ondrop="dragDrop(event, ${t})"
             ondragend="dragEnd(event)"
             ondblclick="removeSongFromCurrentPlaylist('${e}')">
            <div class="flex items-center">
                <span class="text-gray-400 mr-3 font-mono text-sm">${(t+1).toString().padStart(2,"0")}</span>
                <span class="font-medium">${e}</span>
            </div>
            <button onclick="removeSongFromCurrentPlaylist('${e}')" class="text-red-500 hover:text-red-700">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>
    `).join("")}function getAllAvailableSongs(){let e=[],t=[...videoUrls,...newvideoUrls];return t.forEach(t=>{let l=cleanVideoSrcName(t);e.includes(l)||e.push(l)}),e.sort()}function addSongToCurrentPlaylist(e){tempPlaylistSongs.includes(e)||(tempPlaylistSongs.push(e),refreshModalContent())}function removeSongFromCurrentPlaylist(e){tempPlaylistSongs=tempPlaylistSongs.filter(t=>t!==e),refreshModalContent()}function refreshModalContent(){let e=document.getElementById("available-songs"),t=document.getElementById("current-playlist");if(e&&t){e.innerHTML=generateAvailableSongsList(tempPlaylistSongs),t.innerHTML=generateCurrentPlaylistList(tempPlaylistSongs);let l=document.querySelector('button[onclick*="savePlaylist"]');l&&(0===tempPlaylistSongs.length?(l.disabled=!0,l.className=l.className.replace("bg-blue-500","bg-gray-400"),l.className=l.className.replace("hover:bg-blue-600","cursor-not-allowed")):(l.disabled=!1,l.className=l.className.replace("bg-gray-400","bg-blue-500"),l.className=l.className.replace("cursor-not-allowed","hover:bg-blue-600")))}}function closePlaylistEditor(){let e=document.getElementById("playlist-editor-modal");e&&(e.style.opacity="0",setTimeout(()=>{e.remove(),window.isEditingPlaylist=!1},300))}function savePlaylist(e){if(0===tempPlaylistSongs.length){showToast(`Danh s\xe1ch ph\xe1t kh\xf4ng thể trống! Vui l\xf2ng th\xeam \xedt nhất 1 b\xe0i h\xe1t.`,"error");return}let t=JSON.parse(localStorage.getItem("playlists"))||{};t[e].songs=[...tempPlaylistSongs],localStorage.setItem("playlists",JSON.stringify(t)),populateSidebarPlaylists(),closePlaylistEditor(),showToast(`Đ\xe3 lưu th\xe0nh c\xf4ng danh s\xe1ch ph\xe1t ${e}`)}